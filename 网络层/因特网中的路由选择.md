# 4.6 因特网中的路由选择

## 4.6.1 因特网中自治系统的路由选择：RIP

AS：一个处于相同的管理与技术控制下的路由器的集合。

AS内部路由协议又称为内部网关协议，有两个著名的内部网关协议：

1. 路由选择信息协议RIP
2. 开放最短路优先协议OSPF

### RIP协议

RIP是一种距离向量协议，使用跳数作为费用测度。
跳是沿着从源路由器到目的子网的最短路径所经过的子网数量。

路由选择更新信息在邻居之间通过使用一种RIP响应报文，响应报文又称为RIP通告。
一个响应报文包含了一个该AS内的多达25个目的子网的列表，以及发送方到其中每个子网的距离。
这些报文每30秒交换一次。

    课本第258页有一个RIP通告工作的例子。

RIP路由器的邻居不可达时的处理方式：

1. RIP路由器修改本地路由选择表，然后通过向相邻路由器发送RIP通告来传播该消息。
2. RIP路由器还通过使用RIP请求报文，来请求其邻居到指定目的地的费用。
3. 路由器在UDP上使用端口520来相互发送RIP请求与响应报文。

一个令人费解的事实：
    
    RIP使用一个位于网络层协议IP之上的运输层协议UDP来实现网络层功能。

## 4.6.2 因特网中自治系统内部的路由选择：OSPF协议

OSPF的核心：

    一个使用洪泛链路信息的链路状态协议和一个Dijkstra最低费用路径算法。

OSPF的链路状态协议：

1. 路由器向自治系统内所有其他路由器广播路由选择信息。
2. 每当一条链路状态发生变化时，路由器就会广播链路状态信息。
3. 链路状态未发生变化时，它会周期性地广播链路状态。

OSPF的优点：

1. 安全。只有受信任的路由器能参与一个AS内的OSPF协议。
2. 使用多条相同费用的路径。
3. 对单播与多播路由选择的综合支持。
4. 支持在单个路由选择域内的层次结构。

一个OSPF自治系统可以配置成多个区域：

1. AS内只有一个OSPF区域配置成主干区域，包含了AS内的所有区域边界路由器。

        区域边界路由器负责为流向该区域以外的分组提供路由选择。

2. 每个区域运行自己的OSPF链路状态路由选择算法，区域内的路由器向区域内的所有其他路由器广播链路状态。

3. 分组首先路由到区域边界路由器，再通过主干路由到位于目的区域的区域边界路由器，然后再路由到最终目的地。

## 4.6.3 自治系统间的路由选择：BGP

BGP：边界网关协议，用于确定跨越多个AS的源和目的对之间的路径。

每个AS需要进行以下工作：

1. 从相邻AS处获得子网可达性信息。
2. 向本AS内部的所有路由器传播这些可达性信息。
3. 基于可达性信息和AS策略，决定到达子网的好路由。

#### 1. BGP基础

路由器使用179端口的半永久TCP连接来交换路由选择信息。

一些定义：

1. BGP对等方：对于每条TCP连接，位于该连接端点的两台路由器称为BGP对等方。
2. BGP会话：发送BGP报文的TCP连接称为BGP会话。
        
        跨越两个AS的BGP会话称为外部BGP会话(eBGP)。
        在同一个AS中的两台路由器之间的BGP会话称为内部BGP会话(iBGP)。

BGP使得每个AS知道经过其相邻AS可达哪些目的地：

    在BGP中，目的地不是主机而是CIDR化的前缀，每个前缀表示一个子网或一个子网的集合。

BGP如何分发前缀可达性信息：

1. 网关路由器之间使用eBGP会话交换可达性信息。
2. 任何AS中的网关路由器接收到eBGP学习到的前缀后，该网关路由器使用它的iBGP会话来向该AS中的其他路由器发布这些前缀。
3. 当一台路由器得知一个新前缀时，它为该前缀在其转发表中创建一个项。


#### 2. 路径属性和BGP路由

一个自治系统由其全局唯一的自治系统号(ASN)所标识：

    并非所有AS都有ASN，桩AS就没有ASN。
    桩AS仅承载源地址或目的地址为本AS的流量。

当通过BGP会话通告一个前缀时，前缀中常包括一些BGP属性。
包含BGP属性的前缀称为一条路由。

两个重要的BGP属性：

1. AS-PATH，包含了通告已经通过的那些AS。

        路由器使用该AS-PATH来检测和防止循环通告，如果一台路由器看到它的AS被包括在该路径列表中，它将拒绝该通告。

2. NEXT-HOP，开始某AS-PATH的路由器接口的IP地址，也就是第一台路由器的IP地址。

        路由器使用NEXT-HOP正确地配置它们的转发表。
        当AS-PATH和前缀相同时，使用NEXT-HOP确定不同的对等链路。

输入测度：

    网关路由器接收到一台路由器通告时，使用输入策略来决定是否接收或过滤该路由，是否设置某种属性。

#### 3. BGP路由选择

如果对相同前缀存在两条或多条路由，则BGP顺序地调用下列消除规则，直到留下一条路由：

1. 路由被指派一个本地偏好值作为它们的属性。具有最高本地偏好值的路由将被选择。
2. 如果仍有多条路由，则选择最短AS-PATH的路由。
3. 如果仍有多条路由，则选择最靠近NEXT-HOP路由器的路由。
4. 如果仍有多条路由，则使用BGP标识符来选择路由。

#### 4. 路由选择策略

桩网络：所有进入桩网络的流量必定是去往该网络，所有离开桩网络的流量必定是源于该网络。

多宿桩网络：经由两个不同的提供商连接到网络。

桩网络防止转发流量的方式：通过控制BGP路由的通告方式。

    课本第267页有相应的例子。

提供商网络的经验法则：任何穿越某ISP主干网的流量必须是其源或目的位于该ISP的某个客户网络中，否则这些流量将会免费搭车通过该ISP网络。